# 开发步骤


## 简介

开发步骤主要针对服务的开发而非算法，初步选定使用 Django 2 + Python 3 完成服务的建设，之后的展望在初版做完以后升级使用。

## 算法开发

算法开发的时候要做到CPU/GPU可选以适配不同的环境，确定算法输入数据的格式。
（是H×W×C×T的张量，还是文件，如果是文件，那么需要单独写文件转换为输入数据格式的程序）

确定好输入以后，确定输出信息，包括类别数量，概率（是否有？）等等信息。

确定好需要引入的包。

## 接口开发

开发一个POST接口，用于视频分类，其要点如下：

### 输入参数：

|输入名称|类型|备注|
|-|-|-|
|略|文件|视频文件|

如果有其他参数（例如调用模型时候的一些参数）在这里补充

### 输出数据格式：

```js
{
  "status":200, // 200 代表返回成功，其余错误编码参照定义
  "result":{
    // todo 在这里定义你的返回结构
  }
}
```

## 接口调试

开发一个简单的页面，使用FORM来POST本地文件。

## 展望

### 高并发应对策略

#### 策略1：使用线程池/Queue控制并发

每一个任务独占 CPU/GPU 资源，新来的任务放在ThreadPool中，ThreadPool的线程数量为1。

#### 策略2：异步接口

上述的POST接口仅用于上传文件（或者说添加任务），添加成功则返回生成的任务ID，文件暂存在磁盘中，由后台程序轮询检查有无未完成的任务，逐个完成。
另外设计一个GET接口用于获取任务的状态（已完成/未完成/不存在/出错）和结果。

需要注意，文件的读取/刷新和写入需要加锁，否则可能带来其他问题。

#### 附：熔断策略

当队列长度过长的时候，暂停接收任务，可以选择Block住或者直接返回错误信息。

### 文件存储（可选）

设计完成后需要考虑我们的文件存储，一般来说放在磁盘上是一个不错的主意，但是大量的小文件在备份或者恢复的时候可能带来一些麻烦，考虑使用其它分布式的文件系统进行存储，
如果任务需要持久化，那么高并发应对策略最好选择异步策略。

### 状态监控接口（可选）

用于监控当前任务运行的状态，包括队列长度，任务统计等等。

### 前端界面

编写简单的界面，可以取出任务文件（看视频）以及使用ECharts查看分类的结果（排序后各类概率的柱状图或者饼图）。

也可以看一些简单任务统计信息，如果要做到这一点，那么需要你使用数据库管理所有的任务。


## 参考文档

- [Django 中如何开发上传文件的接口](https://docs.djangoproject.com/en/2.2/topics/http/file-uploads/)
